                        <td><button class="edit-btn" onclick="openEditMissionForm('${id}')" ${mission.status === 'تم المراجعة' && !isAdmin ? 'disabled' : ''}>تعديل</button></td>
                        ${isAdmin ? `<td><button class="delete-btn" onclick="deleteMission('${id}')">حذف</button></td>` : ''}
                    </tr>`;
                    missionsTableBody.innerHTML += row;
                }
            });
        }

        function fetchAndDisplayReceipts() {
            const receiptsRef = ref(database, 'receipts');
            onValue(receiptsRef, (snapshot) => {
                const data = snapshot.val();
                const receiptsTableBody = document.getElementById('receiptsTableBody');
                receiptsTableBody.innerHTML = '';
                for (let id in data) {
                    const receipt = data[id];
                    if (!isAdmin && receipt.userEmail !== currentUserEmail) continue;
                    const statusClass = getStatusClass(receipt.status);
                    const row = `<tr>
                        <td>${receipt.date || ''}</td>
                        <td>${receipt.driver || ''}</td>
                        <td>${receipt.delegate || ''}</td>
                        <td>${receipt.carNumber || ''}</td>
                        <td>${receipt.receiptType || ''}</td>
                        <td class="${statusClass}">${receipt.status || 'جاري المراجعة'}</td>
                        <td>${receipt.governorate || ''}</td>
                        <td>${receipt.product || ''}</td>
                        <td>${receipt.floorNumber || ''}</td>
                        <td>${receipt.notes || ''}</td>
                        ${isAdmin ? `<td>${receipt.userEmail || ''}</td>` : ''}
                        <td><button class="edit-btn" onclick="openEditReceiptForm('${id}')" ${receipt.status === 'تم المراجعة' && !isAdmin ? 'disabled' : ''}>تعديل</button></td>
                        ${isAdmin ? `<td><button class="delete-btn" onclick="deleteReceipt('${id}')">حذف</button></td>` : ''}
                    </tr>`;
                    receiptsTableBody.innerHTML += row;
                }
            });
        }

        window.openEditMissionForm = function(id) {
            const missionRef = ref(database, `missions/${id}`);
            onValue(missionRef, (snapshot) => {
                const mission = snapshot.val();
                document.getElementById('editMissionId').value = id;
                document.getElementById('editMissionDate').value = mission.date || '';
                document.getElementById('editMissionDriver').value = mission.driver || '';
                document.getElementById('editMissionCarNumber').value = mission.carNumber || '';
                document.getElementById('editMissionDelegate').value = mission.delegate || '';
                document.getElementById('editMissionDirection').value = mission.direction || '';
                document.getElementById('editMissionTourNumber').value = mission.tourNumber || '';
                document.getElementById('editMissionStartOdometer').value = mission.startOdometer || '';
                document.getElementById('editMissionEndOdometer').value = mission.endOdometer || '';
                document.getElementById('editMissionTripDays').value = mission.tripDays || '';
                document.getElementById('editMissionOvernightAllowance').value = mission.overnightAllowance || 'لا';
                document.getElementById('editMissionNotes').value = mission.notes || '';
                if (isAdmin) {
                    document.getElementById('editMissionStatus').value = mission.status || 'جاري المراجعة';
                }
                document.getElementById('editMissionForm').style.display = 'block';
            });
        }

        window.openEditReceiptForm = function(id) {
            const receiptRef = ref(database, `receipts/${id}`);
            onValue(receiptRef, (snapshot) => {
                const receipt = snapshot.val();
                document.getElementById('editReceiptId').value = id;
                document.getElementById('editReceiptDate').value = receipt.date || '';
                document.getElementById('editReceiptDriver').value = receipt.driver || '';
                document.getElementById('editReceiptDelegate').value = receipt.delegate || '';
                document.getElementById('editReceiptCarNumber').value = receipt.carNumber || '';
                document.getElementById('editReceiptType').value = receipt.receiptType || '';
                document.getElementById('editReceiptGovernorate').value = receipt.governorate || '';
                document.getElementById('editReceiptProduct').value = receipt.product || '';
                document.getElementById('editReceiptFloorNumber').value = receipt.floorNumber || '';
                document.getElementById('editReceiptNotes').value = receipt.notes || '';
                if (isAdmin) {
                    document.getElementById('editReceiptStatus').value = receipt.status || 'جاري المراجعة';
                }
                document.getElementById('editReceiptForm').style.display = 'block';
            });
        }

        window.updateMission = function() {
            const id = document.getElementById('editMissionId').value;
            const updatedMission = {
                date: document.getElementById('editMissionDate').value,
                driver: document.getElementById('editMissionDriver').value,
                carNumber: document.getElementById('editMissionCarNumber').value,
                delegate: document.getElementById('editMissionDelegate').value,
                direction: document.getElementById('editMissionDirection').value,
                tourNumber: document.getElementById('editMissionTourNumber').value,
                startOdometer: document.getElementById('editMissionStartOdometer').value,
                endOdometer: document.getElementById('editMissionEndOdometer').value,
                tripDays: document.getElementById('editMissionTripDays').value,
                overnightAllowance: document.getElementById('editMissionOvernightAllowance').value,
                notes: document.getElementById('editMissionNotes').value
            };
            if (isAdmin) {
                updatedMission.status = document.getElementById('editMissionStatus').value;
            }
            update(ref(database, `missions/${id}`), updatedMission);
            closeEditForm('editMissionForm');
        }

        window.updateReceipt = function() {
            const id = document.getElementById('editReceiptId').value;
            const updatedReceipt = {
                date: document.getElementById('editReceiptDate').value,
                driver: document.getElementById('editReceiptDriver').value,
                delegate: document.getElementById('editReceiptDelegate').value,
                carNumber: document.getElementById('editReceiptCarNumber').value,
                receiptType: document.getElementById('editReceiptType').value,
                governorate: document.getElementById('editReceiptGovernorate').value,
                product: document.getElementById('editReceiptProduct').value,
                floorNumber: document.getElementById('editReceiptFloorNumber').value,
                notes: document.getElementById('editReceiptNotes').value
            };
            if (isAdmin) {
                updatedReceipt.status = document.getElementById('editReceiptStatus').value;
            }
            update(ref(database, `receipts/${id}`), updatedReceipt);
            closeEditForm('editReceiptForm');
        }

        window.closeEditForm = function(formId) {
            document.getElementById(formId).style.display = 'none';
        }

        window.deleteMission = function(id) {
            if (confirm('هل أنت متأكد من حذف هذه المأمورية؟')) {
                remove(ref(database, `missions/${id}`));
            }
        }

        window.deleteReceipt = function(id) {
            if (confirm('هل أنت متأكد من حذف هذا الإيصال؟')) {
                remove(ref(database, `receipts/${id}`));
            }
        }

        window.downloadExcel = function(type) {
            let data;
            let fileName;
            if (type === 'missions') {
                data = getMissionsData();
                fileName = 'المأموريات.xlsx';
            } else if (type === 'receipts') {
                data = getReceiptsData();
                fileName = 'الإيصالات.xlsx';
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
            return buf;
        }

        function getMissionsData() {
            const table = document.getElementById('missionsTable');
            const data = [];
            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = {
                    'التاريخ': row.cells[0].innerText,
                    'اسم السائق': row.cells[1].innerText,
                    'رقم السيارة': row.cells[2].innerText,
                    'اسم المندوب': row.cells[3].innerText,
                    'اتجاه الرحلة': row.cells[4].innerText,
                    'رقم الجولة أو الإذن': row.cells[5].innerText,
                    'عداد البداية': row.cells[6].innerText,
                    'عداد النهاية': row.cells[7].innerText,
                    'عدد أيام الرحلة': row.cells[8].innerText,
                    'بدل مبيت': row.cells[9].innerText,
                    'حالة المأمورية': row.cells[10].innerText,
                    'ملاحظات': row.cells[11].innerText
                };
                if (isAdmin) {
                    rowData['البريد الإلكتروني للمسجل'] = row.cells[12].innerText;
                }
                data.push(rowData);
            }
            return data;
        }

        function getReceiptsData() {
            const table = document.getElementById('receiptsTable');
            const data = [];
            for (let i = 1; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = {
                    'التاريخ': row.cells[0].innerText,
                    'اسم السائق': row.cells[1].innerText,
                    'اسم المندوب': row.cells[2].innerText,
                    'رقم السيارة': row.cells[3].innerText,
                    'نوع الإيصال': row.cells[4].innerText,
                    'حالة الإيصال': row.cells[5].innerText,
                    'المحافظة': row.cells[6].innerText,
                    'المنتج': row.cells[7].innerText,
                    'رقم الدور': row.cells[8].innerText,
                    'ملاحظات': row.cells[9].innerText
                };
                if (isAdmin) {
                    rowData['البريد الإلكتروني للمسجل'] = row.cells[10].innerText;
                }
                data.push(rowData);
            }
            return data;
        }
    </script>
</body>
</html>
